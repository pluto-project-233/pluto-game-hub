generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// IDENTITY SERVICE
// ============================================

model User {
  id                String   @id @default(uuid())
  firebaseUid       String   @unique
  uniqueDisplayName String   @unique
  balance           BigInt   @default(0)
  lockedBalance     BigInt   @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  ledgerEntries LedgerEntry[]
  lobbyPlayers  LobbyPlayer[]
  gameSessions  GameSessionPlayer[]
}

// ============================================
// BANK SERVICE
// ============================================

model Game {
  id           String   @id @default(uuid())
  name         String   @unique
  description  String?
  clientSecret String   // Hashed HMAC secret
  callbackUrl  String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  contracts Contract[]
}

model Contract {
  id          String   @id @default(uuid())
  gameId      String
  name        String
  entryFee    BigInt   // Amount locked per player
  platformFee Int      // Percentage (e.g., 5 = 5%)
  minPlayers  Int
  maxPlayers  Int
  ttlSeconds  Int      @default(3600) // Session timeout
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  game         Game          @relation(fields: [gameId], references: [id])
  lobbies      Lobby[]
  gameSessions GameSession[]

  @@unique([gameId, name])
}

enum LedgerEntryType {
  DEPOSIT    // External funds added
  WITHDRAW   // External funds removed
  LOCK       // Funds locked for game
  UNLOCK     // Funds released (cancel)
  WIN        // Winnings added
  LOSE       // Entry fee deducted
  FEE        // Platform fee deducted
}

model LedgerEntry {
  id          String          @id @default(uuid())
  userId      String
  type        LedgerEntryType
  amount      BigInt          // Always positive
  balanceAfter BigInt         // Snapshot after transaction
  description String?
  sessionId   String?         // Reference to game session
  createdAt   DateTime        @default(now())

  // Relations
  user    User         @relation(fields: [userId], references: [id])
  session GameSession? @relation(fields: [sessionId], references: [id])

  @@index([userId, createdAt])
}

model GameSession {
  id          String            @id @default(uuid())
  contractId  String
  status      GameSessionStatus @default(PENDING)
  totalPot    BigInt            @default(0) // Total locked funds
  expiresAt   DateTime          // TTL for auto-cancel
  createdAt   DateTime          @default(now())
  settledAt   DateTime?

  // Relations
  contract      Contract            @relation(fields: [contractId], references: [id])
  players       GameSessionPlayer[]
  ledgerEntries LedgerEntry[]

  @@index([status, expiresAt])
}

enum GameSessionStatus {
  PENDING   // Created, awaiting game start
  ACTIVE    // Game in progress
  SETTLED   // Rewards distributed
  CANCELLED // Funds returned
  EXPIRED   // TTL exceeded, auto-cancelled
}

model GameSessionPlayer {
  id        String  @id @default(uuid())
  sessionId String
  userId    String
  amountLocked BigInt
  isWinner  Boolean @default(false)
  winAmount BigInt  @default(0)

  // Relations
  session GameSession @relation(fields: [sessionId], references: [id])
  user    User        @relation(fields: [userId], references: [id])

  @@unique([sessionId, userId])
}

// ============================================
// LOBBY SERVICE
// ============================================

enum LobbyStatus {
  WAITING   // Accepting players
  STARTING  // Min players reached, countdown
  IN_GAME   // Game session created
  CLOSED    // Lobby completed or cancelled
}

model Lobby {
  id         String      @id @default(uuid())
  contractId String
  status     LobbyStatus @default(WAITING)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  // Relations
  contract Contract      @relation(fields: [contractId], references: [id])
  players  LobbyPlayer[]

  @@index([contractId, status])
}

model LobbyPlayer {
  id       String   @id @default(uuid())
  lobbyId  String
  userId   String
  joinedAt DateTime @default(now())

  // Relations
  lobby Lobby @relation(fields: [lobbyId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id])

  @@unique([lobbyId, userId])
  @@index([userId])
}

// ============================================
// DICE ROYALE GAME
// ============================================

model DiceRoyaleGame {
  id        String               @id @default(uuid())
  sessionId String               @unique // Links to GameSession
  status    DiceRoyaleStatus     @default(ROLLING)
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt

  // Relations
  rolls DiceRoyaleRoll[]
}

enum DiceRoyaleStatus {
  ROLLING   // Players submitting rolls
  COMPLETE  // All rolls in, winner determined
}

model DiceRoyaleRoll {
  id       String @id @default(uuid())
  gameId   String
  userId   String
  rollValue Int   // 1-6

  // Relations
  game DiceRoyaleGame @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@unique([gameId, userId])
}
